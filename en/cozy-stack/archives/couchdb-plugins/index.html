<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <meta name="author" content="CozyCloud - https://cozy.io">
        <link rel="canonical" href="https://docs.cozy.io/cozy-stack/archives/couchdb-plugins/">
        <link rel="shortcut icon" href="../../../img/favicon.png">
        
        <title>couchdb-plugins - Dev Documentation</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
            <link href="../../../css/extra.css" rel="stylesheet">
            <link href="../../../css/highlight_theme.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

	<script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://docs.cozy.io/">Dev Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../../..">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../tutorials/app/">Create Your Application</a>
</li>
                            
<li >
    <a href="../../../tutorials/konnector/">Develop a Connector</a>
</li>
                            
<li >
    <a href="../../../tutorials/selfhost-debian/">Self-Host on Debian</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">How-to <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">Dev</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../howTos/dev/runCozyDocker/">Run an App in a Cozy using Docker</a>
</li>
            
<li >
    <a href="../../../howTos/dev/hmr/">Use Hot Module Replacement in Your App</a>
</li>
            
<li >
    <a href="../../../howTos/dev/cordova/">Make a Mobile App Using Cordova</a>
</li>
            
<li >
    <a href="../../../howTos/dev/connect-mobile-app-local-stack/">Connect a Mobile App to Your Local Stack</a>
</li>
            
<li >
    <a href="../../../howTos/dev/sendmail/">Send and Receive E-mails in Development</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Synchronize</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../howTos/sync/linux/">Install Cozy Drive on GNU/Linux</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">References <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../references/tech-intro/">Technical introduction to the Cozy platform</a>
</li>
                            
<li >
    <a href="../../../references/git-flow/">Our Front-End Git Flow</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">Stack and tools</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">cozy-app-publish</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-app-publish/README/">CLI & Workflow</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-apps-registry</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-apps-registry/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-client</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-client/getting-started/">Getting started</a>
</li>
            
<li >
    <a href="../../../cozy-client/how-tos/">How tos</a>
</li>
            
<li >
    <a href="../../../cozy-client/api/cozy-client/">Cozy Client API</a>
</li>
            
<li >
    <a href="../../../cozy-client/api/cozy-pouch-link/">Cozy Pouch Link API</a>
</li>
            
<li >
    <a href="../../../cozy-client/api/cozy-stack-client/">Cozy Stack Client API</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-client-js</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-client-js/README/">README</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/intro/">Introduction</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/browser-sdk-transition/">Transition from cozy-browser-sdk</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/offline/">How to support offline</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/oauth/">OAuth guide</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/auth-api/">Authentication API</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/data-api/">Data System API</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/files-api/">Files API</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/jobs-api/">Jobs API</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/intents-api/">Intents API</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/settings-api/">Settings API</a>
</li>
            
<li >
    <a href="../../../cozy-client-js/sharing-api/">Sharing API</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-ui</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-ui/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-doctypes</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-doctypes/docs/README/">README</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.accounts/">Accounts</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.photos.albums/">Albums</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.bank/">Banking doctypes</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.bills/">Bills</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.konnectors/">Connectors</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.contacts/">Contacts</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.files/">Files</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.notifications/">Notifications</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.remote.requests/">Remote requests</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.sessions.logins/">Session logins</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.sharings/">Sharings</a>
</li>
            
<li >
    <a href="../../../cozy-doctypes/docs/io.cozy.triggers/">Triggers</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-konnector-libs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-konnector-libs/api/">API</a>
</li>
            
<li >
    <a href="../../../cozy-konnector-libs/cli/">CLI</a>
</li>
            
<li >
    <a href="../../../cozy-konnector-libs/dev/">Develop</a>
</li>
            
<li >
    <a href="../../../cozy-konnector-libs/errors/">Errors</a>
</li>
            
<li >
    <a href="../../../cozy-konnector-libs/operation-linking/">Operation linking</a>
</li>
            
<li >
    <a href="../../../cozy-konnector-libs/synchronization/">Synchronization</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-stack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../README/">README</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Usage</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../INSTALL/">Install the cozy-stack</a>
</li>
            
<li >
    <a href="../../config/">Configuration file</a>
</li>
            
<li >
    <a href="../../instance/">Managing Instances</a>
</li>
            
<li >
    <a href="../../security/">Security</a>
</li>
            
<li >
    <a href="../../cli/cozy-stack/">Manpages of the command-line tool</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">How-to guides for developpers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../client-app-dev/">Develop a client-side app</a>
</li>
            
<li >
    <a href="../../docker/">Running and building Docker images</a>
</li>
            
<li >
    <a href="../../doctype/">Adding a new doctype</a>
</li>
            
<li >
    <a href="../../assets/">Working with the stack assets</a>
</li>
            
<li >
    <a href="../../release/">Build a release</a>
</li>
            
<li >
    <a href="../../CONTRIBUTING/">The contributing guide</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Explanations</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../sharing-design/">Sharing design</a>
</li>
            
<li >
    <a href="../../konnectors-workflow/">Workflow of the konnectors</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">List of services</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../auth/">/auth - Authentication & OAuth</a>
</li>
            
<li >
    <a href="../../apps/">/apps - Applications Management</a>
</li>
            
<li >
    <a href="../../registry/"> /apps - Apps registry</a>
</li>
            
<li >
    <a href="../../konnectors/"> /apps - Konnectors</a>
</li>
            
<li >
    <a href="../../data-system/">/data - Data System</a>
</li>
            
<li >
    <a href="../../mango/"> /data - Mango</a>
</li>
            
<li >
    <a href="../../couchdb-quirks/"> /data - CouchDB Quirks</a>
</li>
            
<li >
    <a href="../../pouchdb-quirks/"> /data - PouchDB Quirks</a>
</li>
            
<li >
    <a href="../../files/">/files - Virtual File System</a>
</li>
            
<li >
    <a href="../../references-docs-in-vfs/"> /files - References of documents in VFS</a>
</li>
            
<li >
    <a href="../../intents/">/intents - Intents</a>
</li>
            
<li >
    <a href="../../jobs/">/jobs - Jobs</a>
</li>
            
<li >
    <a href="../../workers/"> /jobs - Workers</a>
</li>
            
<li >
    <a href="../../move/">/move - Move, export and import an instance</a>
</li>
            
<li >
    <a href="../../notifications/">/notifications - Notifications</a>
</li>
            
<li >
    <a href="../../public/">/public - Public</a>
</li>
            
<li >
    <a href="../../permissions/">/permissions - Permissions</a>
</li>
            
<li >
    <a href="../../realtime/">/realtime - Realtime</a>
</li>
            
<li >
    <a href="../../remote/">/remote - Proxy for remote data/API</a>
</li>
            
<li >
    <a href="../../settings/">/settings - Settings</a>
</li>
            
<li >
    <a href="../../user-action-required/"> /settings - Terms of Services</a>
</li>
            
<li >
    <a href="../../sharing/">/sharings - Sharing</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">konitor</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../konitor/cli/">CLI</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">babel-preset-cozy-app</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../babel-preset-cozy-app/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">commitlint-config-cozy</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../commitlint-config-cozy/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-device-helper</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-device-helper/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">eslint-config-cozy-app</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../eslint-config-cozy-app/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-flags</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-flags/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-realtime</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../cozy-realtime/README/">README</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li>
                        <a href="https://github.com/cozy/cozy.github.io/">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3 main-toc">
<div class="bs-sidebar hidden-print affix" role="complementary">
    <ul class="nav bs-sidenav well" style='padding-left: 0; padding-right: 0; margin-bottom: 1.5rem'>
        <li class="main active"><a href="#couchdb-plugins-analysis">Couchdb plugins analysis</a></li>
            <li><a href="#existing-packages">Existing packages</a></li>
            <li><a href="#plan-b-make-our-own-from-nethttp">Plan B - Make our own from net/http</a></li>
            <li><a href="#considerations-on-how-we-will-use-it">Considerations on how we will use it</a></li>
            <li><a href="#analysis">Analysis</a></li>
            <li><a href="#going-further-thanks-tomquest">Going further (thanks @tomquest)</a></li>
            <li><a href="#current-decision">Current decision</a></li>
    </ul>
  <div style='padding-left: 2rem'>
    
    <a id='edit-link' href='https://github.com/cozy/cozy.github.io/edit/dev/src/cozy-stack/archives/couchdb-plugins.md'>Edit documentation</a>
    <script type='text/javascript'>
        /* Here we detect if the current page is from an external documentation and we 
        change the href of the editing link so it goes to the right repository and file */
        const outsideDocs = [{"name": "cozy-app-publish", "repo": "https://github.com/cozy/cozy-app-publish.git", "subdir": "."}, {"name": "cozy-apps-registry", "repo": "https://github.com/cozy/cozy-apps-registry.git", "subdir": "."}, {"name": "cozy-client", "repo": "https://github.com/cozy/cozy-client.git", "subdir": "docs"}, {"name": "cozy-client-js", "repo": "https://github.com/cozy/cozy-client-js.git", "subdir": "docs"}, {"name": "cozy-ui", "repo": "https://github.com/cozy/cozy-ui.git", "subdir": "docs"}, {"name": "cozy-doctypes", "repo": "https://github.com/cozy/cozy-doctypes.git", "subdir": "."}, {"name": "cozy-konnector-libs", "repo": "https://github.com/konnectors/libs.git", "subdir": "packages/cozy-konnector-libs/docs"}, {"name": "cozy-scripts", "repo": "https://github.com/CPatchane/create-cozy-app.git", "subdir": "packages/cozy-scripts/docs"}, {"name": "cozy-stack", "repo": "https://github.com/cozy/cozy-stack.git", "subdir": "docs"}, {"name": "konitor", "repo": "https://github.com/konnectors/konitor.git", "subdir": "docs"}, {"name": "babel-preset-cozy-app", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/babel-preset-cozy-app"}, {"name": "commitlint-config-cozy", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/commitlint-config-cozy"}, {"name": "cozy-device-helper", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-device-helper"}, {"name": "eslint-config-cozy-app", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/eslint-config-cozy-app"}, {"name": "cozy-flags", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-flags"}, {"name": "cozy-realtime", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-realtime"}]
        const editNode = document.querySelector('#edit-link')
        const pathname = window.location.pathname
        const editURI = 'edit/master/'
        const removeGitSuffix = function (x) { return x.replace(/\.git$/, '') }

        // Returns the external repo associated to a pathname
        const detectExternalRepo = function (pathname) {
            for (var outsideDoc of outsideDocs) {
                if (window.location.pathname.includes('/' + outsideDoc.name + '/')) {
                    return outsideDoc
                }
            }
        }

        // Change the href attribute of a link to point to the correct edition page on GitHub
        // for the passed external documentation
        const fixEditLink = function (editNode, externalDoc) {
            const repoFile = pathname.replace('/en/' + externalDoc.name, '').replace(/\/$/, '.md')
            const baseRepo = removeGitSuffix(externalDoc.repo)
            editNode.href = baseRepo + '/' + editURI + externalDoc.subdir + repoFile
        }

        const externalRepo = detectExternalRepo(pathname)
        if (externalRepo) {
            fixEditLink(editNode, externalRepo)
        }
    </script>
    
  </div>
</div></div>
                <div class="col-md-9" role="main">
                    

<p><a href="README.md#table-of-contents">Table of contents</a></p>
<p>This document was written in october 2016.</p>
<h1 id="couchdb-plugins-analysis">Couchdb plugins analysis<a class="headerlink" href="#couchdb-plugins-analysis" title="Permanent link">&para;</a></h1>
<p>(original discussion is at https://github.com/cozy/cozy-stack/issues/9)</p>
<h2 id="existing-packages">Existing packages<a class="headerlink" href="#existing-packages" title="Permanent link">&para;</a></h2>
<h3 id="httpsgithubcomtimjacobigo-couchdb">https://github.com/timjacobi/go-couchdb<a class="headerlink" href="#httpsgithubcomtimjacobigo-couchdb" title="Permanent link">&para;</a></h3>
<ul>
<li>last edit 2016-08</li>
<li>Apparently one of the firsts</li>
<li>Includes a http module, trying to figure out why, might simply be history
    (started in 2014)</li>
<li>fork of the &ldquo;original&rdquo; https://github.com/fjl/go-couchdb</li>
<li>brother of https://github.com/pokstad/go-couchdb which is used in this cool
    article : http://pokstad.com/2015/04/18/couchdb-and-go.html</li>
<li>Have tools to run as couchdbapp / couchdbdaemon (we wont use these)</li>
<li>Allow to pass a net/http.RoundTripper for fine transport tunning.</li>
<li>Pr merged with some fix for couchdb2, not sure if there is more issue</li>
</ul>
<h3 id="httpsgithubcomzemircocouchdb">https://github.com/zemirco/couchdb<a class="headerlink" href="#httpsgithubcomzemircocouchdb" title="Permanent link">&para;</a></h3>
<ul>
<li>last edit 2016-08</li>
<li>No functions for changes API</li>
<li>Have a special interface for document {GetID(), GetRev()}</li>
</ul>
<h3 id="httpsgithubcomrhinomancouchdb-go">https://github.com/rhinoman/couchdb-go<a class="headerlink" href="#httpsgithubcomrhinomancouchdb-go" title="Permanent link">&para;</a></h3>
<ul>
<li>last edit 2016-04</li>
<li>No functions for changes API</li>
<li>Have functions for managing users and roles</li>
<li>Have functions for proxying requests (downloads / uploads)</li>
<li>support json byte[] as well as interface{} for documents</li>
<li>Is clean and clear, but more complex because of more functions. We will need
    most those (users, proxy)</li>
</ul>
<h3 id="httpsgithubcomdustingo-couch">https://github.com/dustin/go-couch<a class="headerlink" href="#httpsgithubcomdustingo-couch" title="Permanent link">&para;</a></h3>
<ul>
<li>last edit 2016-08</li>
<li>Simplest</li>
</ul>
<h2 id="plan-b-make-our-own-from-nethttp">Plan B - Make our own from net/http<a class="headerlink" href="#plan-b-make-our-own-from-nethttp" title="Permanent link">&para;</a></h2>
<p>If we go this way, it will be a good idea to look at the code of the other
packages for each function, some pitfalls could be avoided :</p>
<p>ex:</p>
<ul>
<li>https://github.com/rhinoman/couchdb-go/blob/94e6ab663d5789615eb061b52ed2e67310bac13f/connection.go#L81</li>
<li>Use custom Director &amp; httputil.ReverseProxy for file download / upload</li>
</ul>
<h2 id="considerations-on-how-we-will-use-it">Considerations on how we will use it<a class="headerlink" href="#considerations-on-how-we-will-use-it" title="Permanent link">&para;</a></h2>
<p>(see the <a href="../architecture/">architecture</a> for more info)</p>
<ul>
<li>One stack instance communicate with one couchdb 2.x server or cluster. The
    couchdb server/cluster has a lot of databases (nb_users x nb_data_types).
    The pair stack+couch should handle as many active users as possible. Number
    of unactive users must not impact perfs too much. Note : definition of
    active user TBD (mobile app and 3rd party software are syncing using *dav
    and some background jobs like fetching banks accounts and threshold alerts )</li>
<li>HTTPS between stack and couchdb is not a priority. If it&rsquo;s an option, it
    will allow more flexibility for ops team, but we can always find alternative
    solution to secure channel between stack and couchdb and self-hosted users
    will probably have both on an single machine.</li>
<li>We wont keep changes feed open, as it was identified in couchdb workshop as
    the limiting factor on number of databases we can have and we want to have a
    bazillion databases. We will probably do some kind of polling, this will
    need to be investigated deeper.</li>
<li>Binaries will NOT be stored in couchdb. We will only store in couchdb
    reference to the file in another storage solution (FS / Swift)</li>
<li>The stack will use couchdb in 2 ways :<ol>
<li>Just proxying to/from the client, we will still need to parse the JSON,
   but will only read or changes a few special fields (<code>_id</code>, <code>_type</code>,
   <code>_tags</code> ....) for ACL and then pipe it to/from couchdb. We wont need to
   make sense of the whole document and can eventually get away without
   parsing it on some routes. This part should be totally flexible on the
   json content.</li>
<li>Some APIs and Jobs will need to make sense of the given documents, so
   (un)marshal them from/into smarter struct (CalendarEvent) to be used in
   business logic.</li>
</ol>
</li>
</ul>
<h2 id="analysis">Analysis<a class="headerlink" href="#analysis" title="Permanent link">&para;</a></h2>
<ul>
<li>They are all relatively similar in term of API. rhinoman has some more
    functions that we will need but lack changes feed.</li>
<li>They all have a struct for database which hold configuration, as most of our
    request will be on different databases, we will have a great churn for these
    structure. This is less than optimal for RAM &amp; GC, but probably
    insignificant against JSON parsing.</li>
<li>They all use JSON Marshal et encode to accept any interface{} as couchdb
    doc.</li>
<li>They are all relatively inactive / stable, not sure if it is because they
    are &ldquo;finished&rdquo; or abandonware.</li>
<li>No library has a notion of pooling connection. This is handled at the
    net/http.Transport level in golang.</li>
<li>Only the first library has option for fine-tunning of the internal
    Client/Transport,</li>
<li>No library support couchdb2 mango</li>
</ul>
<h2 id="going-further-thanks-tomquest">Going further (thanks @tomquest)<a class="headerlink" href="#going-further-thanks-tomquest" title="Permanent link">&para;</a></h2>
<p>Another advantage of a DIY solution: building exactly what <code>stack</code> needs. This
is orienting the CouchDB access code for Cozy usage. And this could be
implemented as a <strong>DSL</strong>.</p>
<p>For example: <em>(if I understand the architecture, the goal is for an User to have
many Databases, one for each DocumentType)</em></p>
<div class="codehilite"><pre><span></span><span class="c1">// Create an Email</span>
<span class="nx">couchdb</span>
    <span class="p">.</span><span class="nx">Doc</span><span class="p">(</span><span class="nx">anEmail</span><span class="p">)</span> <span class="c1">// deduce the database from the type of the parameters</span>
    <span class="p">.</span><span class="nx">Create</span><span class="p">()</span>
    <span class="c1">// .Update()</span>
    <span class="c1">// .Delete()</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1">// List emails from 100 to 200</span>
<span class="nx">emails</span> <span class="p">=</span> <span class="nx">couchdb</span>
    <span class="p">.</span><span class="nx">emails</span><span class="p">()</span> <span class="c1">// pick the appropriate database</span>
    <span class="p">.</span><span class="nx">Offset</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">Limit</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">Order</span><span class="p">(</span><span class="nx">DATE</span><span class="p">,</span> <span class="nx">DESC</span><span class="p">)</span>
    <span class="p">.</span><span class="k">select</span><span class="p">()</span> <span class="c1">// Create the adhoc CouchDb query (`Mango` style ?)</span>
</pre></div>


<p>BTW, <code>couchdb</code> could be an already configured object with the appropriate user
credentials.</p>
<p>Pros:</p>
<ul>
<li>Cozy-stack oriented (functionally)</li>
<li>Still able to access CouchDb natively (eg. <code>couchdb.Connection()</code>)</li>
<li>Can hide technical stuff: access to the pool, concurrency, caching, https,
    retries, timeouts&hellip;</li>
<li>Build and maintained by Cozy</li>
</ul>
<p>Cons:</p>
<ul>
<li>DSL to write (and testing is a bit harder)</li>
<li>To be maintained, but in fact, this is already the case for the other
    wrappers</li>
</ul>
<h2 id="current-decision">Current decision<a class="headerlink" href="#current-decision" title="Permanent link">&para;</a></h2>
<p>We will make our own driver by cherry picking relevant codes in other libraries.</p>
                </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <!-- Piwik -->
        <script type="text/javascript">
          var _paq = _paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u="//matomo.cozycloud.cc/";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', '7']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <noscript><p><img src="//matomo.cozycloud.cc/piwik.php?idsite=7&rec=1" style="border:0;" alt="" /></p></noscript>
        <!-- End Piwik Code -->
        <script>var base_url = '../../..';</script>
        <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
        <script src="../../../js/base.js"></script>
        <script src="../../../extra.js"></script>
        <script src="../../../search/main.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
