<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <meta name="author" content="CozyCloud - https://cozy.io">
        <link rel="canonical" href="https://docs.cozy.io/tutorials/selfhost-debian/">
        <link rel="shortcut icon" href="../../img/favicon.png">
        
        <title>selfhost-debian - Dev Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
            <link href="../../css/extra.css" rel="stylesheet">
            <link href="../../css/highlight_theme.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://docs.cozy.io/">Dev Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../app/">Create Your Application</a>
</li>
                            
<li >
    <a href="../konnector/">Develop a Connector</a>
</li>
                            
<li >
    <a href="./">Self-Host on Debian</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">How-to <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">Dev</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../howTos/dev/runCozyDocker/">Run an App in a Cozy using Docker</a>
</li>
            
<li >
    <a href="../../howTos/dev/hmr/">Use Hot Module Replacement in Your App</a>
</li>
            
<li >
    <a href="../../howTos/dev/cordova/">Make a Mobile App Using Cordova</a>
</li>
            
<li >
    <a href="../../howTos/dev/connect-mobile-app-local-stack/">Connect a Mobile App to Your Local Stack</a>
</li>
            
<li >
    <a href="../../howTos/dev/sendmail/">Send and Receive E-mails in Development</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Synchronize</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../howTos/sync/linux/">Install Cozy Drive on GNU/Linux</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">References <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../references/tech-intro/">Technical introduction to the Cozy platform</a>
</li>
                            
<li >
    <a href="../../references/git-flow/">Our Front-End Git Flow</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">Stack and tools</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">cozy-app-publish</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-app-publish/README/">CLI & Workflow</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-apps-registry</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-apps-registry/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-client</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-client/getting-started/">Getting started</a>
</li>
            
<li >
    <a href="../../cozy-client/how-tos/">How tos</a>
</li>
            
<li >
    <a href="../../cozy-client/api/cozy-client/">Cozy Client API</a>
</li>
            
<li >
    <a href="../../cozy-client/api/cozy-pouch-link/">Cozy Pouch Link API</a>
</li>
            
<li >
    <a href="../../cozy-client/api/cozy-stack-client/">Cozy Stack Client API</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-client-js</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-client-js/README/">README</a>
</li>
            
<li >
    <a href="../../cozy-client-js/intro/">Introduction</a>
</li>
            
<li >
    <a href="../../cozy-client-js/browser-sdk-transition/">Transition from cozy-browser-sdk</a>
</li>
            
<li >
    <a href="../../cozy-client-js/offline/">How to support offline</a>
</li>
            
<li >
    <a href="../../cozy-client-js/oauth/">OAuth guide</a>
</li>
            
<li >
    <a href="../../cozy-client-js/auth-api/">Authentication API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/data-api/">Data System API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/files-api/">Files API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/jobs-api/">Jobs API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/intents-api/">Intents API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/settings-api/">Settings API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/sharing-api/">Sharing API</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-ui</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-ui/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-doctypes</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-doctypes/docs/README/">README</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.accounts/">Accounts</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.photos.albums/">Albums</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.bank/">Banking doctypes</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.bills/">Bills</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.konnectors/">Connectors</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.contacts/">Contacts</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.files/">Files</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.notifications/">Notifications</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.remote.requests/">Remote requests</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.sessions.logins/">Session logins</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.sharings/">Sharings</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.triggers/">Triggers</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-konnector-libs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-konnector-libs/api/">API</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/cli/">CLI</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/dev/">Develop</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/errors/">Errors</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/operation-linking/">Operation linking</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/synchronization/">Synchronization</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-stack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/README/">README</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Architecture</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/architecture/">General overview</a>
</li>
            
<li >
    <a href="../../cozy-stack/security/">Security</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Usage</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/INSTALL/">Install the cozy-stack</a>
</li>
            
<li >
    <a href="../../cozy-stack/cli/cozy-stack/">Manpages of the command-line tool</a>
</li>
            
<li >
    <a href="../../cozy-stack/config/">Configuration file</a>
</li>
            
<li >
    <a href="../../cozy-stack/instance/">Managing Instances</a>
</li>
            
<li >
    <a href="../../cozy-stack/onboarding/">Onboarding</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">For developpers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/client-app-dev/">Develop a client-side app</a>
</li>
            
<li >
    <a href="../../cozy-stack/docker/">Running and building Docker images</a>
</li>
            
<li >
    <a href="../../cozy-stack/assets/">Working with the stacka assets</a>
</li>
            
<li >
    <a href="../../cozy-stack/release/">Build a release</a>
</li>
            
<li >
    <a href="../../cozy-stack/CONTRIBUTING/">The contributing guide</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Services</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/auth/">/auth - Authentication & OAuth</a>
</li>
            
<li >
    <a href="../../cozy-stack/apps/">/apps - Applications Management</a>
</li>
            
<li >
    <a href="../../cozy-stack/registry/"> /apps - Apps registry</a>
</li>
            
<li >
    <a href="../../cozy-stack/konnectors/"> /apps - Konnectors</a>
</li>
            
<li >
    <a href="../../cozy-stack/konnectors-workflow/"> /apps - Konnectors workflow</a>
</li>
            
<li >
    <a href="../../cozy-stack/data-system/">/data - Data System</a>
</li>
            
<li >
    <a href="../../cozy-stack/mango/"> /data - Mango</a>
</li>
            
<li >
    <a href="../../cozy-stack/replication/"> /data - Replication</a>
</li>
            
<li >
    <a href="../../cozy-stack/couchdb-quirks/"> /data - CouchDB Quirks</a>
</li>
            
<li >
    <a href="../../cozy-stack/pouchdb-quirks/"> /data - PouchDB Quirks</a>
</li>
            
<li >
    <a href="../../cozy-stack/files/">/files - Virtual File System</a>
</li>
            
<li >
    <a href="../../cozy-stack/references-docs-in-vfs/"> /files - References of documents in VFS</a>
</li>
            
<li >
    <a href="../../cozy-stack/intents/">/intents - Intents</a>
</li>
            
<li >
    <a href="../../cozy-stack/jobs/">/jobs - Jobs</a>
</li>
            
<li >
    <a href="../../cozy-stack/workers/"> /jobs - Workers</a>
</li>
            
<li >
    <a href="../../cozy-stack/move/">/move - Move, export and import an instance</a>
</li>
            
<li >
    <a href="../../cozy-stack/notifications/">/notifications - Notifications</a>
</li>
            
<li >
    <a href="../../cozy-stack/public/">/public - Public</a>
</li>
            
<li >
    <a href="../../cozy-stack/permissions/">/permissions - Permissions</a>
</li>
            
<li >
    <a href="../../cozy-stack/realtime/">/realtime - Realtime</a>
</li>
            
<li >
    <a href="../../cozy-stack/remote/">/remote - Proxy for remote data/API</a>
</li>
            
<li >
    <a href="../../cozy-stack/settings/">/settings - Settings</a>
</li>
            
<li >
    <a href="../../cozy-stack/user-action-required/"> /settings - Terms of Services</a>
</li>
            
<li >
    <a href="../../cozy-stack/sharing/">/sharings - Sharing</a>
</li>
            
<li >
    <a href="../../cozy-stack/sharing-design/"> /sharings - Request for comments</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">konitor</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../konitor/cli/">CLI</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">babel-preset-cozy-app</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../babel-preset-cozy-app/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">commitlint-config-cozy</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../commitlint-config-cozy/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-device-helper</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-device-helper/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">eslint-config-cozy-app</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../eslint-config-cozy-app/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-flags</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-flags/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-realtime</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-realtime/README/">README</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li>
                        <a href="https://github.com/cozy/cozy.github.io/">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                    <div class="main-page-head col-md-9">
                        <h1 class="main-head-title">Install Cozy on a Debian server</h1>
                            <p>Self-host your own Cozy</p>
                        <hr />
                    </div>
                <div class="col-md-3 main-toc">
<div class="bs-sidebar hidden-print affix" role="complementary">
    <ul class="nav bs-sidenav well" style='padding-left: 0; padding-right: 0; margin-bottom: 1.5rem'>
        <li class="main active"><a href="#prerequisites">Prerequisites</a></li>
            <li><a href="#third-party-repositories">Third party repositories</a></li>
            <li><a href="#cozy-repositories">Cozy repositories</a></li>
        <li class="main "><a href="#setup">Setup</a></li>
            <li><a href="#couchdb">CouchDB</a></li>
            <li><a href="#cozy-stack">Cozy stack</a></li>
            <li><a href="#finally">Finally</a></li>
        <li class="main "><a href="#cozy-instance-setup">Cozy instance setup</a></li>
            <li><a href="#dns">DNS</a></li>
            <li><a href="#acme-lets-encrypt">ACME (Let's Encrypt)</a></li>
            <li><a href="#create-instances">Create instances</a></li>
    </ul>
  <div style='padding-left: 2rem'>
    
    <a id='edit-link' href='https://github.com/cozy/cozy.github.io/edit/dev/src/tutorials/selfhost-debian.md'>Edit documentation</a>
    <script type='text/javascript'>
        /* Here we detect if the current page is from an external documentation and we 
        change the href of the editing link so it goes to the right repository and file */
        const outsideDocs = [{"name": "cozy-app-publish", "repo": "https://github.com/cozy/cozy-app-publish.git", "subdir": "."}, {"name": "cozy-apps-registry", "repo": "https://github.com/cozy/cozy-apps-registry.git", "subdir": "."}, {"name": "cozy-client", "repo": "https://github.com/cozy/cozy-client.git", "subdir": "docs"}, {"name": "cozy-client-js", "repo": "https://github.com/cozy/cozy-client-js.git", "subdir": "docs"}, {"name": "cozy-ui", "repo": "https://github.com/cozy/cozy-ui.git", "subdir": "docs"}, {"name": "cozy-doctypes", "repo": "https://github.com/cozy/cozy-doctypes.git", "subdir": "."}, {"name": "cozy-konnector-libs", "repo": "https://github.com/konnectors/libs.git", "subdir": "packages/cozy-konnector-libs/docs"}, {"name": "cozy-scripts", "repo": "https://github.com/CPatchane/create-cozy-app.git", "subdir": "packages/cozy-scripts/docs"}, {"name": "cozy-stack", "repo": "https://github.com/cozy/cozy-stack.git", "subdir": "docs"}, {"name": "konitor", "repo": "https://github.com/konnectors/konitor.git", "subdir": "docs"}, {"name": "babel-preset-cozy-app", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/babel-preset-cozy-app"}, {"name": "commitlint-config-cozy", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/commitlint-config-cozy"}, {"name": "cozy-device-helper", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-device-helper"}, {"name": "eslint-config-cozy-app", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/eslint-config-cozy-app"}, {"name": "cozy-flags", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-flags"}, {"name": "cozy-realtime", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-realtime"}]
        const editNode = document.querySelector('#edit-link')
        const pathname = window.location.pathname
        const editURI = 'edit/master/'
        const removeGitSuffix = function (x) { return x.replace(/\.git$/, '') }

        // Returns the external repo associated to a pathname
        const detectExternalRepo = function (pathname) {
            for (var outsideDoc of outsideDocs) {
                if (window.location.pathname.includes('/' + outsideDoc.name + '/')) {
                    return outsideDoc
                }
            }
        }

        // Change the href attribute of a link to point to the correct edition page on GitHub
        // for the passed external documentation
        const fixEditLink = function (editNode, externalDoc) {
            const repoFile = pathname.replace('/en/' + externalDoc.name, '').replace(/\/$/, '.md')
            const baseRepo = removeGitSuffix(externalDoc.repo)
            editNode.href = baseRepo + '/' + editURI + externalDoc.subdir + repoFile
        }

        const externalRepo = detectExternalRepo(pathname)
        if (externalRepo) {
            fixEditLink(editNode, externalRepo)
        }
    </script>
    
  </div>
</div></div>
                <div class="col-md-9" role="main">
                    

<p>A Debian repository serves packages to setup a Cozy self-hosted environment.</p>
<p>It provides:</p>
<ul>
<li><code>cozy-couchdb</code>: <a href="https://couchdb.apache.org/">CouchDB</a> database engine used by cozy</li>
<li><code>cozy-nsjail</code>: <a href="http://nsjail.com/">NSJail</a> isolation tool used by konnectors</li>
<li><code>cozy-stack</code>: <a href="https://github.com/cozy/cozy-stack/">Cozy core</a></li>
<li><code>cozy-coclyco</code>: <a href="https://github.com/cozy/cozy-coclyco/">CLI</a> to manage vhosts and certificates</li>
<li><code>cozy</code>: metapackage installing everything to setup a self-hosted environment</li>
</ul>
<p>This repository currently supports:</p>
<ul>
<li><strong>Debian Stretch</strong> (9.x): amd64</li>
<li><strong>Raspbian Stretch</strong> (9.x): armhf</li>
</ul>
<p>Available channels are:</p>
<ul>
<li><strong>stable</strong>: official and supported releases</li>
<li><strong>testing</strong>: future official releases, for testing purposes. Updated ± twice a month.</li>
</ul>
<p><code>cozy-couchdb</code> and <code>cozy-nsjail</code> are temporary packages. They will be removed when official <code>couchdb</code> and <code>nsjail</code> will be available</p>
<p>You can choose to install <code>cozy-couchdb</code> on the same host as <code>cozy-stack</code>, or use a remote CouchDB server. Cozy only needs a 2.x CouchDB (1.x not supported).</p>
<p>Like CouchDB, you can choose to install your reverse proxy on the same host, or use a remote one. Right now <code>cozy-coclyco</code> supports only local <code>nginx</code>. If you want to use <code>apache2</code> or remote reverse proxy, you need to manually configure it for vhost or TLS certificate issuances.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<h3 id="third-party-repositories">Third party repositories<a class="headerlink" href="#third-party-repositories" title="Permanent link">&para;</a></h3>
<p><a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> official packages require to use unofficial/third party repositories to have recent and supported version of ACME libraries.
Packages provided by standard Debian repositories are quite old and not compatible with <code>cozy-coclyco</code>.</p>
<ul>
<li>For Debian/Raspbian, you need to <a href="https://certbot.eff.org/lets-encrypt/debianstretch-apache#using">enable <code>backports</code> repository</a>.</li>
</ul>
<p>Refer to the <a href="https://certbot.eff.org/">certbot</a> documentation to activate needed repositories.
(You don&rsquo;t need to install packages like <code>certbot</code> or <code>python-certbot-xxx</code>, only to activate repositories.)</p>
<p>You may change your <a href="https://manpages.debian.org/stretch/apt/apt_preferences.5.html">APT preferences</a> to allow APT to install from backports/ppa by default instead of from official repositories. For example:</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;Package: python3-acme</span>
<span class="s2">Pin: release n=stretch-backports</span>
<span class="s2">Pin-Priority: 510&quot;</span> &gt; /etc/apt/preferences.d/cozy
</pre></div>


<h3 id="cozy-repositories">Cozy repositories<a class="headerlink" href="#cozy-repositories" title="Permanent link">&para;</a></h3>
<p>First, install the packages required to install cozy</p>
<div class="codehilite"><pre><span></span>apt install ca-certificates apt-transport-https wget
</pre></div>


<p>Then, fetch the GPG Cozy signing key:</p>
<div class="codehilite"><pre><span></span>wget https://apt.cozy.io/cozy-keyring.deb
dpkg -i cozy-keyring.deb
</pre></div>


<p>Finally, setup your repository. Select the channel that best fit your needs:</p>
<div class="admonition warning">
<p>For now, we recommend to use <code>testing</code> repositories.
<code>stable</code> packages are quite old and currently provide deprecated and unsecured CouchDB version (2.0.x).
Adapt your <code>sources.list</code> accordingly.</p>
</div>
<p>Supported repositories are:</p>
<ul>
<li>Debian Stretch (9.x)<ul>
<li>deb https://apt.cozy.io/debian/ stretch stable</li>
<li>deb https://apt.cozy.io/debian/ stretch testing</li>
</ul>
</li>
<li>Raspbian Stretch (9.x)<ul>
<li>deb https://apt.cozy.io/raspbian/ stretch stable</li>
<li>deb https://apt.cozy.io/raspbian/ stretch testing</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;deb https://apt.cozy.io/debian/ stretch testing&quot;</span> &gt; /etc/apt/sources.list.d/cozy.list
apt update
</pre></div>


<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>For the rest of this document, we assume you install components one by one to allow intermediate verification</p>
<p>For a full local environment (<code>couchdb</code> + <code>nginx</code> + <code>cozy</code>), just install the <code>cozy</code> package which can install all needed packages in one shot.</p>
<h3 id="couchdb">CouchDB<a class="headerlink" href="#couchdb" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>apt install cozy-couchdb
</pre></div>


<p>Install CouchDB in <code>standalone</code> mode</p>
<p>Configure CouchDB to listen on <code>127.0.0.1</code></p>
<p>Pick an administrator password
(This password is used by shell scripts, so currently avoid to use one with simple or double quotes or others shell meaningfull symbols. We advice you to choose one with only alphanumeric digits to avoid troubles.)</p>
<p>At this point, you must have a working CouchDB instance</p>
<div class="codehilite"><pre><span></span>curl http://localhost:5984/
<span class="o">{</span><span class="s2">&quot;couchdb&quot;</span>:<span class="s2">&quot;Welcome&quot;</span>,<span class="s2">&quot;version&quot;</span>:<span class="s2">&quot;2.1.0&quot;</span>,<span class="s2">&quot;features&quot;</span>:<span class="o">[</span><span class="s2">&quot;scheduler&quot;</span><span class="o">]</span>,<span class="s2">&quot;vendor&quot;</span>:<span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;The Apache Software Foundation&quot;</span><span class="o">}}</span>
</pre></div>


<h3 id="cozy-stack">Cozy stack<a class="headerlink" href="#cozy-stack" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>apt install cozy-stack
</pre></div>


<p>Cozy need to create a CouchDB administrator and so to connect as admin to the CouchDB. Fill those mandatory parameters to allow this creation:</p>
<ul>
<li>Address: by default, it&rsquo;s <code>localhost:5984</code></li>
<li>Node name: by default, it&rsquo;s <code>couchdb@localhost</code></li>
<li>Admin user: by default, it&rsquo;s <code>admin</code></li>
<li>Admin password: put the one you choose during CouchDB setup</li>
<li>Cozy user: by default, it&rsquo;s <code>cozy</code></li>
<li>Cozy password: pick a password</li>
</ul>
<p>(Those passwords are used by shell scripts, so currently avoid to use ones with simple or double quotes or others shell meaningfull symbols. We advice you to choose ones with only alphanumeric digits to avoid troubles.)</p>
<p>For stack management (create instances, install applications&hellip;), <a href="https://github.com/cozy/cozy-stack/blob/2ae446d85b60c89fb56cad1f7ed469cddca94494/docs/config.md#user-content-administration-secret">Cozy need an administrator password</a>. So pick a new one.
When invoking <code>cozy-stack</code> (or <code>cozy-coclyco</code> which use it under the hood), you need to set the <code>COZY_ADMIN_PASSWORD</code> environment variable with this password. You can put it on your <code>.bashrc</code> for simplier life if you want. If you don&rsquo;t, cozy-stack will simply ask for it.</p>
<p>At this point, you must have a working Cozy stack, depending on the branch you&rsquo;ve chosen you can get a different version displayed.</p>
<div class="codehilite"><pre><span></span>curl http://localhost:8080/version
<span class="o">{</span><span class="s2">&quot;build_mode&quot;</span>:<span class="s2">&quot;production&quot;</span>,<span class="s2">&quot;build_time&quot;</span>:<span class="s2">&quot;2017-09-28T10:26:03Z&quot;</span>,<span class="s2">&quot;runtime_version&quot;</span>:<span class="s2">&quot;go1.8.1&quot;</span>,<span class="s2">&quot;version&quot;</span>:<span class="s2">&quot;0.1.0&quot;</span><span class="o">}</span><span class="c1">#</span>
</pre></div>


<p>If you want to use konnectors, you need to initialize the NodeJS chroot</p>
<p>(Currently this script only works for Debian and will be adapted for Raspbian soon)</p>
<div class="codehilite"><pre><span></span>/usr/share/cozy/konnector-create-chroot.sh
</pre></div>


<p>You also need to enable user namespaces:</p>
<div class="codehilite"><pre><span></span>sysctl -w kernel.unprivileged_userns_clone<span class="o">=</span><span class="m">1</span>
</pre></div>


<p>If you use a self-signed certificate or a not official certificate authority, you need to deploy the corresponding root certificate in <code>/usr/share/cozy/chroot/etc/ssl/certs/custom.crt</code>.
For example, if you use <a href="https://letsencrypt.org/docs/staging-environment/">Let&rsquo;s Encrypt staging environment</a> for testing purpose :</p>
<div class="codehilite"><pre><span></span>wget -q https://letsencrypt.org/certs/fakelerootx1.pem <span class="se">\</span>
    -O /usr/share/cozy/chroot/etc/ssl/certs/custom.crt
</pre></div>


<h3 id="finally">Finally<a class="headerlink" href="#finally" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>apt install cozy
</pre></div>


<h2 id="cozy-instance-setup">Cozy instance setup<a class="headerlink" href="#cozy-instance-setup" title="Permanent link">&para;</a></h2>
<h3 id="dns">DNS<a class="headerlink" href="#dns" title="Permanent link">&para;</a></h3>
<p>Cozy relies on sub-domains for each applications you installed on your instance.
For an instance <code>cozy.example.org</code>, <code>&lt;app&gt;.cozy.example.org</code> must be available too. Currently, you need at least:</p>
<ul>
<li><code>onboarding.cozy.example.org</code></li>
<li><code>settings.cozy.example.org</code></li>
<li><code>drive.cozy.example.org</code></li>
<li><code>photos.cozy.example.org</code></li>
<li><code>home.cozy.example.org</code></li>
<li><code>store.cozy.example.org</code></li>
<li><code>&lt;app&gt;.cozy.example.org</code> for each application you use</li>
</ul>
<p>Follow your usual way to create those entries on your domain zone.
The simpliest way to handle this is to use a wildcard entry if supported by your domain hosting.</p>
<div class="codehilite"><pre><span></span>cozy 1h IN A x.x.x.x
*.cozy 1h IN CNAME cozy
</pre></div>


<h3 id="acme-lets-encrypt">ACME (Let&rsquo;s Encrypt)<a class="headerlink" href="#acme-lets-encrypt" title="Permanent link">&para;</a></h3>
<p>Like DNS, each application will use a different sub-domain and so request a certificate which include all needed domains.</p>
<p><code>cozy-coclyco</code> use Let&rsquo;s Encrypt and it ACME protocol to prove your ownership over the domain you try to issue a certificate.
This protocol requires your reverse proxy to be able to serve <code>http://&lt;app&gt;.cozy.example.org/.well-known/acme-challenge/</code> requests correctly.</p>
<p>The simplest way to achieve this is to configure your reverse proxy with a generic rule to forward any <code>/.well-known/acme-challenge/</code> request to the corresponding <code>/etc
/ssl/private/acme-challenge/</code> folder.
For <code>nginx</code>, this can be done with</p>
<div class="codehilite"><pre><span></span><span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">sites-available</span><span class="o">/</span><span class="nt">default</span>
<span class="nt">server</span> <span class="p">{</span>
    <span class="err">listen</span> <span class="err">80</span> <span class="err">default_server</span><span class="p">;</span>
    <span class="n">listen</span> <span class="cp">[</span><span class="p">::</span><span class="cp">]</span><span class="p">:</span><span class="mi">80</span> <span class="n">default_server</span><span class="p">;</span>

    <span class="err">root</span> <span class="err">/var/www/html</span><span class="p">;</span>
    <span class="err">server_name</span> <span class="err">_</span><span class="p">;</span>

    <span class="err">location</span> <span class="err">/.well-known/acme-challenge/</span> <span class="err">{</span>
        <span class="err">alias</span> <span class="err">/etc/ssl/private/acme-challenge/</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="err">return</span> <span class="err">301</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">host</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
    <span class="p">}</span>
<span class="err">}</span>

<span class="nt">apt</span> <span class="nt">install</span> <span class="nt">ssl-cert</span>
<span class="nt">adduser</span> <span class="nt">www-data</span> <span class="nt">ssl-cert</span>
<span class="nt">systemctl</span> <span class="nt">restart</span> <span class="nt">nginx</span>
</pre></div>


<h3 id="create-instances">Create instances<a class="headerlink" href="#create-instances" title="Permanent link">&para;</a></h3>
<p>Once you&rsquo;ve got a stack, your DNS and your reverse proxy correctly configured, you can create instances on your Cozy stack.
Remember to set the <code>COZY_ADMIN_PASSWORD</code> environment variable.</p>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">COZY_ADMIN_PASSWORD</span><span class="o">=</span>&lt;your-admin-password&gt;
cozy-coclyco create cozy.example.org me@example.org
</pre></div>


<p>For complete reference of Coclyco, refer to the documentation of <a href="https://github.com/cozy/cozy-coclyco/blob/master/README.md">cozy-coclyco</a>.</p>
                </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <!-- Piwik -->
        <script type="text/javascript">
          var _paq = _paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u="//matomo.cozycloud.cc/";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', '7']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <noscript><p><img src="//matomo.cozycloud.cc/piwik.php?idsite=7&rec=1" style="border:0;" alt="" /></p></noscript>
        <!-- End Piwik Code -->
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../extra.js"></script>
        <script src="../../search/main.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
