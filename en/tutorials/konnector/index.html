<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <meta name="author" content="CozyCloud - https://cozy.io">
        <link rel="canonical" href="https://docs.cozy.io/tutorials/konnector/">
        <link rel="shortcut icon" href="../../img/favicon.png">
        
        <title>konnector - Dev Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
            <link href="../../css/extra.css" rel="stylesheet">
            <link href="../../css/highlight_theme.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://docs.cozy.io/">Dev Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../app/">Create Your Application</a>
</li>
                            
<li >
    <a href="./">Develop a Connector</a>
</li>
                            
<li >
    <a href="../selfhost-debian/">Self-Host on Debian</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">How-to <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">Dev</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../howTos/dev/runCozyDocker/">Run an App in a Cozy using Docker</a>
</li>
            
<li >
    <a href="../../howTos/dev/hmr/">Use Hot Module Replacement in Your App</a>
</li>
            
<li >
    <a href="../../howTos/dev/cordova/">Make a Mobile App Using Cordova</a>
</li>
            
<li >
    <a href="../../howTos/dev/connect-mobile-app-local-stack/">Connect a Mobile App to Your Local Stack</a>
</li>
            
<li >
    <a href="../../howTos/dev/sendmail/">Send and Receive E-mails in Development</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Synchronize</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../howTos/sync/linux/">Install Cozy Drive on GNU/Linux</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">References <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../references/tech-intro/">Technical introduction to the Cozy platform</a>
</li>
                            
<li >
    <a href="../../references/git-flow/">Our Front-End Git Flow</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">Stack and tools</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">cozy-app-publish</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-app-publish/README/">CLI & Workflow</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-apps-registry</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-apps-registry/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-client</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-client/getting-started/">Getting started</a>
</li>
            
<li >
    <a href="../../cozy-client/how-tos/">How tos</a>
</li>
            
<li >
    <a href="../../cozy-client/api/cozy-client/">Cozy Client API</a>
</li>
            
<li >
    <a href="../../cozy-client/api/cozy-pouch-link/">Cozy Pouch Link API</a>
</li>
            
<li >
    <a href="../../cozy-client/api/cozy-stack-client/">Cozy Stack Client API</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-client-js</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-client-js/README/">README</a>
</li>
            
<li >
    <a href="../../cozy-client-js/intro/">Introduction</a>
</li>
            
<li >
    <a href="../../cozy-client-js/browser-sdk-transition/">Transition from cozy-browser-sdk</a>
</li>
            
<li >
    <a href="../../cozy-client-js/offline/">How to support offline</a>
</li>
            
<li >
    <a href="../../cozy-client-js/oauth/">OAuth guide</a>
</li>
            
<li >
    <a href="../../cozy-client-js/auth-api/">Authentication API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/data-api/">Data System API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/files-api/">Files API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/jobs-api/">Jobs API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/intents-api/">Intents API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/settings-api/">Settings API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/sharing-api/">Sharing API</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-ui</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-ui/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-doctypes</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-doctypes/docs/README/">README</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.accounts/">Accounts</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.photos.albums/">Albums</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.bank/">Banking doctypes</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.bills/">Bills</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.konnectors/">Connectors</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.contacts/">Contacts</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.files/">Files</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.notifications/">Notifications</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.remote.requests/">Remote requests</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.sessions.logins/">Session logins</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.sharings/">Sharings</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.triggers/">Triggers</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-konnector-libs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-konnector-libs/api/">API</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/cli/">CLI</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/dev/">Develop</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/errors/">Errors</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/operation-linking/">Operation linking</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/synchronization/">Synchronization</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-stack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/README/">README</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Usage</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/INSTALL/">Install the cozy-stack</a>
</li>
            
<li >
    <a href="../../cozy-stack/config/">Configuration file</a>
</li>
            
<li >
    <a href="../../cozy-stack/instance/">Managing Instances</a>
</li>
            
<li >
    <a href="../../cozy-stack/security/">Security</a>
</li>
            
<li >
    <a href="../../cozy-stack/cli/cozy-stack/">Manpages of the command-line tool</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">How-to guides for developpers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/client-app-dev/">Develop a client-side app</a>
</li>
            
<li >
    <a href="../../cozy-stack/docker/">Running and building Docker images</a>
</li>
            
<li >
    <a href="../../cozy-stack/doctype/">Adding a new doctype</a>
</li>
            
<li >
    <a href="../../cozy-stack/assets/">Working with the stack assets</a>
</li>
            
<li >
    <a href="../../cozy-stack/release/">Build a release</a>
</li>
            
<li >
    <a href="../../cozy-stack/CONTRIBUTING/">The contributing guide</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Explanations</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/sharing-design/">Sharing design</a>
</li>
            
<li >
    <a href="../../cozy-stack/konnectors-workflow/">Workflow of the konnectors</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">List of services</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-stack/auth/">/auth - Authentication & OAuth</a>
</li>
            
<li >
    <a href="../../cozy-stack/apps/">/apps - Applications Management</a>
</li>
            
<li >
    <a href="../../cozy-stack/registry/"> /apps - Apps registry</a>
</li>
            
<li >
    <a href="../../cozy-stack/konnectors/"> /apps - Konnectors</a>
</li>
            
<li >
    <a href="../../cozy-stack/data-system/">/data - Data System</a>
</li>
            
<li >
    <a href="../../cozy-stack/mango/"> /data - Mango</a>
</li>
            
<li >
    <a href="../../cozy-stack/replication/"> /data - Replication</a>
</li>
            
<li >
    <a href="../../cozy-stack/couchdb-quirks/"> /data - CouchDB Quirks</a>
</li>
            
<li >
    <a href="../../cozy-stack/pouchdb-quirks/"> /data - PouchDB Quirks</a>
</li>
            
<li >
    <a href="../../cozy-stack/files/">/files - Virtual File System</a>
</li>
            
<li >
    <a href="../../cozy-stack/references-docs-in-vfs/"> /files - References of documents in VFS</a>
</li>
            
<li >
    <a href="../../cozy-stack/intents/">/intents - Intents</a>
</li>
            
<li >
    <a href="../../cozy-stack/jobs/">/jobs - Jobs</a>
</li>
            
<li >
    <a href="../../cozy-stack/workers/"> /jobs - Workers</a>
</li>
            
<li >
    <a href="../../cozy-stack/move/">/move - Move, export and import an instance</a>
</li>
            
<li >
    <a href="../../cozy-stack/notifications/">/notifications - Notifications</a>
</li>
            
<li >
    <a href="../../cozy-stack/public/">/public - Public</a>
</li>
            
<li >
    <a href="../../cozy-stack/permissions/">/permissions - Permissions</a>
</li>
            
<li >
    <a href="../../cozy-stack/realtime/">/realtime - Realtime</a>
</li>
            
<li >
    <a href="../../cozy-stack/remote/">/remote - Proxy for remote data/API</a>
</li>
            
<li >
    <a href="../../cozy-stack/settings/">/settings - Settings</a>
</li>
            
<li >
    <a href="../../cozy-stack/user-action-required/"> /settings - Terms of Services</a>
</li>
            
<li >
    <a href="../../cozy-stack/sharing/">/sharings - Sharing</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">konitor</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../konitor/cli/">CLI</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">babel-preset-cozy-app</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../babel-preset-cozy-app/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">commitlint-config-cozy</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../commitlint-config-cozy/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-device-helper</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-device-helper/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">eslint-config-cozy-app</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../eslint-config-cozy-app/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-flags</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-flags/README/">README</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-realtime</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-realtime/README/">README</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li>
                        <a href="https://github.com/cozy/cozy.github.io/">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                    <div class="main-page-head col-md-9">
                        <h1 class="main-head-title">How to write a connector</h1>
                            <p>And import data from a service to your Cozy</p>
                        <hr />
                    </div>
                <div class="col-md-3 main-toc">
<div class="bs-sidebar hidden-print affix" role="complementary">
    <ul class="nav bs-sidenav well" style='padding-left: 0; padding-right: 0; margin-bottom: 1.5rem'>
        <li class="main active"><a href="#introduction">Introduction</a></li>
        <li class="main "><a href="#how-does-it-work">How does it work?</a></li>
        <li class="main "><a href="#lets-create-our-first-connector">Let’s create our first connector</a></li>
            <li><a href="#run-the-sample">Run the sample</a></li>
            <li><a href="#implement-your-connector">Implement your connector</a></li>
        <li class="main "><a href="#going-further">Going further</a></li>
            <li><a href="#connector-structure">Connector structure</a></li>
        <li class="main "><a href="#linking-your-connector-to-a-cozy-dev-mode">Linking your connector to a cozy : dev mode</a></li>
            <li><a href="#the-manifest">The manifest</a></li>
            <li><a href="#konnector-dev-configjson">konnector-dev-config.json</a></li>
            <li><a href="#run-the-dev-mode">Run the dev mode</a></li>
        <li class="main "><a href="#integration-in-the-store-for-all-the-users">Integration in the store for all the users</a></li>
            <li><a href="#icon">Icon</a></li>
            <li><a href="#packagejson">Package.json</a></li>
            <li><a href="#manifestkonnector">Manifest.konnector</a></li>
        <li class="main "><a href="#faq">FAQ</a></li>
            <li><a href="#when-i-run-my-connector-a-ghost-node-process-eats-all-my-memory">When I run my connector, a ghost node process eats all my memory</a></li>
            <li><a href="#how-do-i-scrap-a-website">How do I scrap a website</a></li>
    </ul>
  <div style='padding-left: 2rem'>
    
    <a id='edit-link' href='https://github.com/cozy/cozy.github.io/edit/dev/src/tutorials/konnector.md'>Edit documentation</a>
    <script type='text/javascript'>
        /* Here we detect if the current page is from an external documentation and we 
        change the href of the editing link so it goes to the right repository and file */
        const outsideDocs = [{"name": "cozy-app-publish", "repo": "https://github.com/cozy/cozy-app-publish.git", "subdir": "."}, {"name": "cozy-apps-registry", "repo": "https://github.com/cozy/cozy-apps-registry.git", "subdir": "."}, {"name": "cozy-client", "repo": "https://github.com/cozy/cozy-client.git", "subdir": "docs"}, {"name": "cozy-client-js", "repo": "https://github.com/cozy/cozy-client-js.git", "subdir": "docs"}, {"name": "cozy-ui", "repo": "https://github.com/cozy/cozy-ui.git", "subdir": "docs"}, {"name": "cozy-doctypes", "repo": "https://github.com/cozy/cozy-doctypes.git", "subdir": "."}, {"name": "cozy-konnector-libs", "repo": "https://github.com/konnectors/libs.git", "subdir": "packages/cozy-konnector-libs/docs"}, {"name": "cozy-scripts", "repo": "https://github.com/CPatchane/create-cozy-app.git", "subdir": "packages/cozy-scripts/docs"}, {"name": "cozy-stack", "repo": "https://github.com/cozy/cozy-stack.git", "subdir": "docs"}, {"name": "konitor", "repo": "https://github.com/konnectors/konitor.git", "subdir": "docs"}, {"name": "babel-preset-cozy-app", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/babel-preset-cozy-app"}, {"name": "commitlint-config-cozy", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/commitlint-config-cozy"}, {"name": "cozy-device-helper", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-device-helper"}, {"name": "eslint-config-cozy-app", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/eslint-config-cozy-app"}, {"name": "cozy-flags", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-flags"}, {"name": "cozy-realtime", "repo": "https://github.com/cozy/cozy-libs.git", "subdir": "packages/cozy-realtime"}]
        const editNode = document.querySelector('#edit-link')
        const pathname = window.location.pathname
        const editURI = 'edit/master/'
        const removeGitSuffix = function (x) { return x.replace(/\.git$/, '') }

        // Returns the external repo associated to a pathname
        const detectExternalRepo = function (pathname) {
            for (var outsideDoc of outsideDocs) {
                if (window.location.pathname.includes('/' + outsideDoc.name + '/')) {
                    return outsideDoc
                }
            }
        }

        // Change the href attribute of a link to point to the correct edition page on GitHub
        // for the passed external documentation
        const fixEditLink = function (editNode, externalDoc) {
            const repoFile = pathname.replace('/en/' + externalDoc.name, '').replace(/\/$/, '.md')
            const baseRepo = removeGitSuffix(externalDoc.repo)
            editNode.href = baseRepo + '/' + editURI + externalDoc.subdir + repoFile
        }

        const externalRepo = detectExternalRepo(pathname)
        if (externalRepo) {
            fixEditLink(editNode, externalRepo)
        }
    </script>
    
  </div>
</div></div>
                <div class="col-md-9" role="main">
                    

<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>A connector (also known as <em>konnector</em>) is a script that imports data from another web service and put those data into your cozy.
Each connector is an independent application, managed by the <a href="https://github.com/cozy/cozy-collect">Cozy Collect</a> application.</p>
<p>To protect your data, each connector runs inside a container in order to sandbox all their interactions with your data.</p>
<blockquote>
<p>⚠️ For historical reasons, in the Cozy codebase, a cozy connector is named konnector, please follow this convention if modifying an existing application.</p>
</blockquote>
<h2 id="how-does-it-work">How does it work?<a class="headerlink" href="#how-does-it-work" title="Permanent link">&para;</a></h2>
<p>A connector is a NodeJS script.
The target node version used to run your connector is the version 8.</p>
<p>Like client side apps, connectors communicate with the <a href="https://docs.cozy.io/en/cozy-stack/README/">Cozy Stack</a> using its HTTP API, and get a unique auth token every time they start.
They need to register with a manifest, and ask the user for permissions.</p>
<p>To facilitate connector development, a npm package, <a href="https://github.com/konnectors/libs">cozy-konnector-libs</a>, provides some shared libraries that are adapted to be used for a connector:</p>
<ul>
<li><a href="https://cheerio.js.org">cheerio</a> to easily query a HTML page</li>
<li><a href="https://github.com/request/request-promise">request-promise</a>: <a href="https://github.com/request/request">request</a> with Promise support</li>
<li><a href="https://github.com/request/request-debug">request-debug</a> that displays all the requests and responses in the standard output.
   Toggle <em>debug</em> option in <a href="https://github.com/konnectors/libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_requestFactory">requestFactory options</a></li>
</ul>
<p>Besides, you&rsquo;ll probably need some other npm packages to help you run your connector:</p>
<ul>
<li><a href="http://momentjs.com/docs/">momentjs</a> or <a href="https://date-fns.org">date-fns</a> to manage dates</li>
<li><a href="http://bluebirdjs.com">bluebird</a> to get enhanced promises</li>
</ul>
<p>When the connector is started, it also receives some data via environment variables:</p>
<ul>
<li><code>COZY_CREDENTIALS</code>: an auth token used by <a href="https://github.com/cozy/cozy-client-js/">cozy-client-js</a> to communicate with the server</li>
<li><code>COZY_URL</code>: the Cozy Stack API entry point</li>
<li><code>COZY_FIELDS</code>: settings coming from <a href="https://github.com/cozy/cozy-collect">Cozy Collect</a> and filled by the user (login, password, directory path).</li>
</ul>
<p>These variables are used by the connector and the cozy-client to configure the connection to the <a href="https://cozy.github.io/cozy-stack/">Cozy Stack</a> with the right permissions as defined in the connector manifest.
They are simulated in standalone mode so that you do not need a real Cozy Stack to develop a connector.
[<a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#basekonnector">More about BaseKonnector</a>]</p>
<p>From the server point of view, each connector is a <code>job</code> which is executed periodically via a <code>trigger</code>.
[<a href="https://cozy.github.io/cozy-stack/jobs.html">More about Cozy Stack jobs</a>]</p>
<h2 id="lets-create-our-first-connector">Let’s create our first connector<a class="headerlink" href="#lets-create-our-first-connector" title="Permanent link">&para;</a></h2>
<p>The easiest way to create a new connector is to use <a href="https://github.com/konnectors/cozy-konnector-template">cozy-konnector-template</a>:</p>
<p>ℹ There is also a <a href="https://www.youtube.com/watch?v=gp0cE8kHEBc&amp;list=PLBgB0F1WGyOXMqKZe-Q1ql0Fz-ohPkq6-">(french) youtube video to create your first connector</a></p>
<h3 id="run-the-sample">Run the sample<a class="headerlink" href="#run-the-sample" title="Permanent link">&para;</a></h3>
<p>First of all, <a href="https://github.com/konnectors/cozy-konnector-template/archive/master.zip">download</a> or clone the repository:</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/konnectors/cozy-konnector-template cozy-konnector-newservice
<span class="nb">cd</span> cozy-konnector-newservice
rm -rf .git
git init
yarn install <span class="c1"># or npm install</span>
</pre></div>


<p><em>note: we use <code>yarn</code>, but if you prefer <code>npm</code>, keep using it, everything should work.</em></p>
<p>The connector is ready to run with sample code.
As a demo we will scrape a fictional website: <a href="http://books.toscrape.com">books.toscrape.com</a>, for which <strong>you do not need credentials</strong>.</p>
<p>As indicated in the <code>README.md</code> file, just run:</p>
<div class="codehilite"><pre><span></span>yarn standalone <span class="c1"># or npm run standalone</span>
</pre></div>


<p>The very first run will create a <code>konnector-dev-config.json</code> file that allows you to configure the connector input when executing it with the CLI.
This configuration comes from <a href="https://github.com/cozy/cozy-collect">Cozy Collect</a> when deployed.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;COZY_URL&quot;</span><span class="p">:</span> <span class="s2">&quot;http://cozy.tools:8080&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="err">//</span> <span class="err">configuration</span> <span class="err">injected</span> <span class="err">to</span> <span class="err">the</span> <span class="err">start</span> <span class="err">function</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The <code>fields</code> property allows you to set credentials for the targeted web service, such as <code>login</code> and <code>password</code> as if they come from <a href="https://cozy.github.io/cozy-stack/">Cozy Stack</a> (so from a real Cozy Cloud instance). You can add as many fields as the targeted service needs. 
The <code>COZY_URL</code> property will be used later. You do not need to change it for now.</p>
<p>As explained earlier, the demo website <a href="http://books.toscrape.com">books.toscrape.com</a> does not need any credentials.
But for the code to run without error, you need to register a <em>fake</em> login and a <em>fake</em> password:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;COZY_URL&quot;</span><span class="p">:</span> <span class="s2">&quot;http://cozy.tools:8080&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;zuck.m@rk.fb&quot;</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;123456&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>In the template, this configuration file is already added to <code>.gitignore</code> file to be sure your credentials stay private.</strong></p>
<p>Now you can run the connector again in <em>standalone</em> mode to see how jpg and related data are downloaded.
In this mode, [<code>cozy-client-js</code>] is stubbed and all data meant to be saved in a cozy are displayed in the standard output and files are saved in the ./data directory of the connector.
This is useful to start developing your connector without handling the state of a real <a href="https://cozy.github.io/cozy-stack/">Cozy Stack</a>.</p>
<p>Please check <a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/cli.md">CLI section of the documentation</a> for more information.</p>
<h3 id="implement-your-connector">Implement your connector<a class="headerlink" href="#implement-your-connector" title="Permanent link">&para;</a></h3>
<p>There are four steps for a connector to save data to <a href="https://cozy.github.io/cozy-stack/">Cozy Stack</a>:</p>
<ol>
<li>authentication</li>
<li>request data</li>
<li>parse and format data</li>
<li>save data to cozy stack</li>
</ol>
<p>You can see these steps in the <code>src/index.js</code> in the <a href="https://github.com/konnectors/template/blob/master/src/index.js">konnectors/template</a>:</p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">start</span><span class="p">(</span><span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// step 1.</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;Authenticating ...&#39;</span><span class="p">)</span>
  <span class="nx">await</span> <span class="nx">authenticate</span><span class="p">(</span><span class="nx">fields</span><span class="p">.</span><span class="nx">login</span><span class="p">,</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;Successfully logged in&#39;</span><span class="p">)</span>

  <span class="c1">// step 2.</span>
  <span class="c1">// The BaseKonnector instance expects a Promise as return of the function</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;Fetching the list of documents&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">request</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/index.html`</span><span class="p">)</span>

  <span class="c1">// step 3.</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;Parsing list of documents&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">documents</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">parseDocuments</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span>

  <span class="c1">// step 4.</span>
  <span class="c1">// here we use the saveBills function even if what we fetch are not bills, but this is the most</span>
  <span class="c1">// common case in connectors</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;Saving data to Cozy&#39;</span><span class="p">)</span>
  <span class="nx">await</span> <span class="nx">saveBills</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">folderPath</span><span class="p">,</span> <span class="p">{</span>
    <span class="c1">// this is a bank identifier which will be used to link bills to bank operations. These</span>
    <span class="c1">// identifiers should be at least a word found in the title of a bank operation related to this</span>
    <span class="c1">// bill. It is not case sensitive.</span>
    <span class="nx">identifiers</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;books&#39;</span><span class="p">]</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></div>


<h4 id="authentication">Authentication<a class="headerlink" href="#authentication" title="Permanent link">&para;</a></h4>
<p>Open the <code>src/index.js</code> file, there are comments to guide you through it.
The very first step is to be able to authenticate to the remote service, this is done with the line:</p>
<p><em>note: don&rsquo;t forget to add your additional fields if you have some.</em></p>
<div class="codehilite"><pre><span></span><span class="nx">await</span> <span class="nx">authenticate</span><span class="p">(</span><span class="nx">fields</span><span class="p">.</span><span class="nx">login</span><span class="p">,</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
</pre></div>


<p>There are many obstacles at this level:</p>
<ul>
<li>is there a captcha?</li>
<li>is there a 2FA?</li>
<li>how is the <code>&lt;form&gt;</code>?</li>
</ul>
<p><em>note: if the remote service exposes an API, you should use classical <a href="https://github.com/request/request-promise">request</a> call.</em></p>
<p>Let&rsquo;s say the remote service exposes a simple classical form like https://www.trainline.eu/signin:</p>
<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;signin-form&quot;</span> <span class="na">novalidate</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;signin__form&quot;</span> <span class="na">data-ember-action</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">data-ember-action-680</span><span class="o">=</span><span class="s">&quot;680&quot;</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;email&quot;</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">&quot;on&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Email Address&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;ember691&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ember-text-field textfield ember-view&quot;</span>
    <span class="na">data-enpass</span><span class="err">.</span><span class="na">usermodified</span><span class="o">=</span><span class="s">&quot;yes&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;email&quot;</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">&quot;on&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Password&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;ember696&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ember-text-field textfield ember-view&quot;</span>
    <span class="na">data-enpass</span><span class="err">.</span><span class="na">usermodified</span><span class="o">=</span><span class="s">&quot;yes&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;signin__forgot&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">data-ember-action</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">data-ember-action-697</span><span class="o">=</span><span class="s">&quot;697&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/password&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;ember698&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ember-view&quot;</span><span class="p">&gt;</span> Forgot your password?
      <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;signin__buttons &quot;</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;signin__buttons-block&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;signin__button&quot;</span><span class="p">&gt;</span>
        Sign In
      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>


<p>Find a CSS selector for the form tag: <code>form#signin-form</code>.
Find the <strong>name</strong> of the input tags used to host user&rsquo;s credentials: <code>email</code> and <code>password</code>.</p>
<p>You are ready to complete the <code>signin(options)</code> object called in the <code>authenticate(username, password)</code> function:</p>
<div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">authenticate</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">signin</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="sb">`https://www.trainline.eu/signin`</span><span class="p">,</span>
    <span class="nx">formSelector</span><span class="o">:</span> <span class="s1">&#39;form#signin-form&#39;</span><span class="p">,</span>
    <span class="nx">formData</span><span class="o">:</span> <span class="p">{</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="c1">// &quot;email&quot; and &quot;password&quot; correspond to the name attribut of the HTML inputs</span>
    <span class="nx">validate</span><span class="o">:</span> <span class="p">(</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// write some code to validate the form submission</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></div>


<p>To implement the <code>validate</code> function, you need to check what is happening on a successful login and on an unsuccessful login.
With the https://www.trainline.eu/signin example, fill the form with wrong credentials, open your browser&rsquo;s devtools (and check the network tab) and submit the form.
Here it is clear, on incorrect credentials, the response have a status code <code>422</code>:</p>
<div class="codehilite"><pre><span></span><span class="err">HTTP/2.0 422 No Reason Phrase</span>
</pre></div>


<p>Do the same with valid credentials.</p>
<div class="codehilite"><pre><span></span><span class="err">HTTP/2.0 200 OK</span>
</pre></div>


<p>Then you can write a simple and straight forward <code>validate</code> code:</p>
<div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">authenticate</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">signin</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="sb">`https://www.trainline.eu/signin`</span><span class="p">,</span>
    <span class="nx">formSelector</span><span class="o">:</span> <span class="s1">&#39;form#signin-form&#39;</span><span class="p">,</span>
    <span class="nx">formData</span><span class="o">:</span> <span class="p">{</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span>
    <span class="nx">validate</span><span class="o">:</span> <span class="p">(</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">statusCode</span> <span class="o">===</span> <span class="mi">200</span> <span class="o">||</span> <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid credentials&#39;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></div>


<p>However if the target website doesn&rsquo;t use <code>statusCode</code> correctly you can also use <code>fullResponse.request.uri.href</code> to check if there is a redirection to a page that requires to be logged in :</p>
<div class="codehilite"><pre><span></span><span class="nx">validate</span><span class="o">:</span> <span class="p">(</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">fullResponse</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">fullResponse</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">href</span> <span class="o">==</span> <span class="s1">&#39;https://example.com/account&#39;</span> <span class="o">||</span> <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid credentials&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>It is also possible to use Cheerio to check if an HTML element is present in the web page or not :</p>
<div class="codehilite"><pre><span></span><span class="nx">validate</span><span class="o">:</span> <span class="p">(</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a[href=&quot;https://example.com/logout&quot;]&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.error&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>


<h4 id="request-data">Request data<a class="headerlink" href="#request-data" title="Permanent link">&para;</a></h4>
<p>Once the connector is able to be authenticated by the online service, the next step is to fetch data.
The most common case is that the invoices we want to fetch are listed in a HTML page.
So to request data, we fetch the target webpage that contains invoices list.</p>
<p>But sometimes, the webpage is a JavaScript page that uses a JSON API URL.
JSON is easier to parse than full HTML webpages.</p>
<p>For the purpose of this guide, let&rsquo;s consider we are in the case of a full HTML webpage, like the service given as an example in the template: http://books.toscrape.com</p>
<p>This is the easiest part, just fetch the webpage:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;http://books.toscrape.com/index.html&#39;</span><span class="p">)</span>
</pre></div>


<p>The <code>$</code> variable is set to a <a href="https://cheerio.js.org/">cheerio</a> object with <a href="https://github.com/request/request-promise#crawl-a-webpage-better">useful API to crawl the webpage</a>.</p>
<p>ℹ You can name this variable as you want and create as many as you want Cheerio variables such as : <code>$doc</code> or <code>$page</code>.</p>
<p>That object will be very useful for the next step.</p>
<h4 id="parse-the-document">Parse the document<a class="headerlink" href="#parse-the-document" title="Permanent link">&para;</a></h4>
<p>We want to get every <code>&lt;article /&gt;</code> of the page in a JavaScript Array:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">articles</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">map</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">,</span> <span class="nx">node</span> <span class="p">=&gt;</span> <span class="nx">node</span><span class="p">))</span>
</pre></div>


<p>For every book, we want to catch the title attribute of this tag <code>article h3 a</code>.
This is a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors">CSS Selector</a> that <a href="https://cheerio.js.org/">cheerio</a> understands to select some part of the tree.
In order to crawl a list of items to create an Array of JSON object, we can create our own function or use the function <a href="https://github.com/konnectors/libs/blob/master/packages/cozy-konnector-libs/docs/api.md#scrape">scrape from the connector libs</a>:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">docs</span> <span class="o">=</span> <span class="nx">scrape</span><span class="p">(</span>
  <span class="nx">$</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">sel</span><span class="o">:</span> <span class="s1">&#39;h3 a&#39;</span><span class="p">,</span>
      <span class="nx">attr</span><span class="o">:</span> <span class="s1">&#39;title&#39;</span>
    <span class="p">},</span>
    <span class="nx">amount</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">sel</span><span class="o">:</span> <span class="s1">&#39;.price_color&#39;</span><span class="p">,</span>
      <span class="nx">parse</span><span class="o">:</span> <span class="nx">normalizePrice</span>
    <span class="p">},</span>
    <span class="nx">url</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">sel</span><span class="o">:</span> <span class="s1">&#39;h3 a&#39;</span><span class="p">,</span>
      <span class="nx">attr</span><span class="o">:</span> <span class="s1">&#39;href&#39;</span><span class="p">,</span>
      <span class="nx">parse</span><span class="o">:</span> <span class="nx">url</span> <span class="p">=&gt;</span> <span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">`</span>
    <span class="p">},</span>
    <span class="nx">fileurl</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">sel</span><span class="o">:</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span>
      <span class="nx">attr</span><span class="o">:</span> <span class="s1">&#39;src&#39;</span><span class="p">,</span>
      <span class="nx">parse</span><span class="o">:</span> <span class="nx">src</span> <span class="p">=&gt;</span> <span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">src</span><span class="si">}</span><span class="sb">`</span>
    <span class="p">},</span>
    <span class="nx">filename</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">sel</span><span class="o">:</span> <span class="s1">&#39;h3 a&#39;</span><span class="p">,</span>
      <span class="nx">attr</span><span class="o">:</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
      <span class="nx">parse</span><span class="o">:</span> <span class="nx">title</span> <span class="p">=&gt;</span> <span class="sb">`</span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb">.jpg`</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s1">&#39;article&#39;</span>
<span class="p">)</span>
</pre></div>


<blockquote>
<p>Keep in mind that there are many useful CSS <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Introduction_to_CSS/Pseudo-classes_and_pseudo-elements">Pseudo-classes</a> and <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Introduction_to_CSS/Combinators_and_multiple_selectors">Combinators</a>  that you can use in your CSS selectors to help you select HTML elements.</p>
</blockquote>
<p>This code will loop on <code>&lt;article /&gt;</code> and for each item will create a JSON object with the selector <code>sel</code> and the value of attribute <code>attr</code> if specified, otherwise it takes the value of the child node, this value can be edited with the <code>parse</code> function.
Here is a sample for the following markup from http://books.toscrape.com:</p>
<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">article</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;product_pod&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;image_container&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;catalogue/a-light-in-the-attic_1000/index.html&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg&quot;</span> <span class="na">alt</span><span class="o">=</span><span class="s">&quot;A Light in the Attic&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;thumbnail&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;star-rating Three&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-star&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-star&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-star&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-star&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-star&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;catalogue/a-light-in-the-attic_1000/index.html&quot;</span> <span class="na">title</span><span class="o">=</span><span class="s">&quot;A Light in the Attic&quot;</span><span class="p">&gt;</span>A Light in the ...<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;product_price&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;price_color&quot;</span><span class="p">&gt;</span>£51.77<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;instock availability&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-ok&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
      In stock
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">data-loading-text</span><span class="o">=</span><span class="s">&quot;Adding...&quot;</span><span class="p">&gt;</span>Add to basket<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">article</span><span class="p">&gt;</span>
</pre></div>


<p>And we will get the following JSON object:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;A Light in the Attic&quot;</span><span class="p">,</span>
  <span class="nt">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">51.77</span><span class="p">,</span>
  <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://books.toscrape.com/catalogue/a-light-in-the-attic_1000/index.html&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fileurl&quot;</span><span class="p">:</span> <span class="s2">&quot;http://books.toscrape.com/media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg&quot;</span><span class="p">,</span>
  <span class="nt">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;A Light in the Attic.jpg&quot;</span>
<span class="p">}</span>
</pre></div>


<p><code>fileurl</code> is used to tell Cozy where to find the file (here an image) to retreive. Then you can save it to Cozy Stack (see section below).</p>
<p>There are many <a href="https://github.com/cozy/cozy-doctypes">document types</a> (Doctypes) you can store in your Cozy, such as : 
- <a href="https://github.com/cozy/cozy-doctypes/blob/master/docs/io.cozy.bills.md">Bills</a>
- <a href="https://github.com/cozy/cozy-doctypes/blob/master/docs/io.cozy.contacts.md">Contacts</a>
- <a href="https://github.com/cozy/cozy-doctypes/blob/master/docs/io.cozy.bank.md">Bank</a>
- and so on…</p>
<p>The code sample includes some other function to manipulate the result object, but we have the idea.
Once we build a correct object, we can save it to Cozy Stack.</p>
<h4 id="save-data-to-cozy-stack">Save data to Cozy Stack<a class="headerlink" href="#save-data-to-cozy-stack" title="Permanent link">&para;</a></h4>
<p>In the example we use some built-in function to save a bill to the Cozy Stack.
But there is a bunch of functions available depending on what you want:</p>
<ul>
<li><a href="https://github.com/konnectors/libs/blob/master/packages/cozy-konnector-libs/docs/api.md#adddata"><code>addData</code></a></li>
<li><a href="https://github.com/konnectors/libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_hydrateAndFilter"><code>hydrateAndFilter</code></a></li>
<li><a href="https://github.com/konnectors/libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_saveBills"><code>saveBills</code></a> to save invoices files (this function use <code>saveFiles</code>) that can be linked to your bank transactions.</li>
<li><a href="https://github.com/konnectors/libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_saveFiles"><code>saveFiles</code></a> to upload files to Cozy Drive.</li>
<li>and so on…</li>
</ul>
<p>For example, to save bills to Cozy you have to start by recovering all required fields for a data type <a href="https://github.com/cozy/cozy-doctypes/blob/master/docs/io.cozy.bills.md">io.cozy.bills</a> using the <code>scrape</code> function, and then you can use the function <code>saveBills</code> to save your docs to Cozy Stack as shown below:</p>
<div class="codehilite"><pre><span></span><span class="nx">await</span> <span class="nx">saveBills</span><span class="p">(</span><span class="nx">documents</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">idenditifiers</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;vendor&#39;</span><span class="p">],</span> <span class="c1">// name of the target website</span>
  <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/pdf&#39;</span>
<span class="p">})</span>
</pre></div>


<p><em><code>documents</code> is the list of bills returned by the function <code>parseDocuments</code> after the page scraping</em>.</p>
<p>We can find more information in the <a href="https://github.com/konnectors/libs/blob/master/packages/cozy-konnector-libs/docs/api.md">libs repository</a>.</p>
<p><strong>Now that we pass on every steps, it is time to test the connector with <code>yarn standalone</code>.</strong>
We will see next how to connect it effectively to a Cozy Stack.</p>
<hr />
<h2 id="going-further">Going further<a class="headerlink" href="#going-further" title="Permanent link">&para;</a></h2>
<h3 id="connector-structure">Connector structure<a class="headerlink" href="#connector-structure" title="Permanent link">&para;</a></h3>
<p>Basically, a connector is just a function passed to the <code>BaseKonnector</code> constructor, and which
eventually returns a promise:</p>
<p>To create the connector, just create a new instance of <code>BaseKonnector</code> with a function as argument:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="p">{</span><span class="nx">BaseKonnector</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cozy-konnector-libs&#39;</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseKonnector</span><span class="p">(</span><span class="nx">fields</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="c1">// use fields to get user credentials and choices</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="s1">&#39;fields&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>


<h4 id="typical-workflow">Typical workflow<a class="headerlink" href="#typical-workflow" title="Permanent link">&para;</a></h4>
<p>Everytime the connector is run, it will call the function and wait for the resolution of the returned promise.
This function can then:</p>
<ul>
<li>log into the target website,</li>
<li>fetch data,</li>
<li>and save them as an array of objects with specific attributes expected by the save function (<code>saveFiles</code>, <code>addData</code>, <code>hydrateAndFilter</code>, <code>saveBills</code>).</li>
</ul>
<p>A basic connector workflow involves:</p>
<ol>
<li>authenticate on the website or API. Might be tricky, but that&rsquo;s the fun :-)</li>
<li>getting data from the online service. You can get the data by calling an API or scraping the webpage. Check if the webpage itself is not using an API to retrieve data, might speed up our job. Mobile phones applications usually connects to an API that might be a reliable source of data.
 </br>A quick <a href="#How-do-I-scrape-my-data-from-a-website">exemple of a scraper here</a>.</li>
<li>filtering data to remove the ones already present inside the database using <a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_hydrateAndFilter">hydrateAndFilter</a></li>
<li>save the filtered data into the database (<a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#adddata">addData</a>)</li>
<li>save the related files using (<a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#savefiles">saveFiles</a>)</li>
</ol>
<h4 id="error-handling">Error handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h4>
<p>If your connector hits an issue fetching or saving the data, it can return an error code by throwing it as an error. The error codes are defined inside the <a href="https://github.com/cozy/cozy-collect">Cozy Collect</a> application and will display an explicit error to the user:</p>
<ul>
<li><code>LOGIN_FAILED</code>: the connector could not login</li>
<li><code>NOT_EXISTING_DIRECTORY</code>: the folder specified as folder_to_save does not exist (checked automatically by the BaseKonnector)</li>
<li><code>UNKNOWN_ERROR</code>: there was an unexpected error, please take a look at the logs to know what happened</li>
<li><code>VENDOR_DOWN</code>: the target web site is down now</li>
<li><code>USER_ACTION_NEEDED</code>: The user needs to login to the service to do manual actions (could be Terms Of Service to validate)</li>
</ul>
<p>You can get the list of error codes in <code>require('cozy-konnector-libs').errors</code> (<a href="https://github.com/konnectors/libs/blob/master/packages/cozy-konnector-libs/src/helpers/errors.js">source</a>)</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="p">{</span><span class="nx">BaseKonnector</span><span class="p">,</span> <span class="nx">errors</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cozy-konnector-libs&#39;</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseKonnector</span><span class="p">(</span><span class="nx">fields</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Here, the following message will be displayed in cozy-collect : &quot;Bad credentials. Check the konnector fields and run the connection again.&quot;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">LOGIN_FAILED</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>


<h4 id="cozy-konnector-libs"><a href="https://github.com/cozy/cozy-konnector-libs">cozy-konnector-libs</a><a class="headerlink" href="#cozy-konnector-libs" title="Permanent link">&para;</a></h4>
<p>The Cozy Konnector Libs provide several useful methods for common tasks:</p>
<ul>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#basekonnector">BaseKonnector</a>: creates the connector and fetches from the stack the connector&rsquo;s parameters (COZY_FIELDS&hellip;)</li>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#cozyclient">cozyClient</a> gives an instance of <a href="https://github.com/cozy/cozy-client-js/">cozy-client-js</a> already initialized according to <code>COZY_URL</code>, and <code>COZY_CREDENTIALS</code>. Your code can immediately interact with the server thanks to this client.</li>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_requestFactory">requestFactory</a> a function which returns an instance of request-promise initialized with defaults often used in connector development.</li>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/3cad316bac1898ef3c2656577af786f6549b40b0/packages/cozy-logger/src/index.js#L35-L41">log</a> allows to log messages with different levels</li>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#hydrateAndFilter">hydrateAndFilter</a> to filter data</li>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#adddata">addData</a> to store the retrieved data into the cozy</li>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#linkbankoperations">linkBankOperations</a> to link a bill to a bank operation</li>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#savebills">saveBills</a> which uses hydrateAndFilter, addData, saveFiles and linkBankOperations and which is specific to bills</li>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#updateorcreate">updateOrCreate</a> create or update documents inside database</li>
<li><a href="">htmlToPDF</a> to convert HTML code to PDF content to insert into a PDF file created with the <code>createCozyPDFDocument</code> function</li>
<li><a href="">createCozyPDFDocument</a> to create a new PDF file to pass to <code>htmlToPDF</code></li>
</ul>
<h2 id="linking-your-connector-to-a-cozy-dev-mode">Linking your connector to a cozy : <code>dev mode</code><a class="headerlink" href="#linking-your-connector-to-a-cozy-dev-mode" title="Permanent link">&para;</a></h2>
<p>After several <code>yarn standalone</code>, your connector is able to automaticaly gather data from the targeted web service. </br>It&rsquo;s time now to put this data in a real cozy. </br>Here comes the <em>dev mode</em>.</p>
<p>For that your connector needs more setup :
<em> a <code>manifest.konnector</code> file
</em> a <code>COZY_URL</code> section in <code>konnector-dev-config.json</code></p>
<h3 id="the-manifest">The manifest<a class="headerlink" href="#the-manifest" title="Permanent link">&para;</a></h3>
<p>Each connector is described by a manifest. This is a JSON file named <code>manifest.konnector</code> at the root of your code folder. It should include the following minimal information:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;konnector name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;node&quot;</span><span class="p">,</span>
  <span class="nt">&quot;slug&quot;</span><span class="p">:</span> <span class="s2">&quot;konnectorslug&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span>
  <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;git://github.com/cozy/cozy-konnector-thename.git&quot;</span><span class="p">,</span>
  <span class="nt">&quot;permissions&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;accounts&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Required to get the account&#39;s data&quot;</span><span class="p">,</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;io.cozy.accounts&quot;</span><span class="p">,</span>
      <span class="nt">&quot;verbs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><a href="https://github.com/cozy/cozy-konnector-template">cozy-konnector-template</a> already has a manifest which you can customize.</p>
<p>You may add some permissions for your own doctype. <a href="https://docs.cozy.io/en/cozy-stack/konnectors/#the-manifest">Here</a> is the detailed list of fields for a
connector manifest file.</p>
<p>You can also get more information on permissions in the official <a href="https://github.com/cozy/cozy-stack/blob/master/docs/permissions.md">cozy-stack documentation</a></p>
<h3 id="konnector-dev-configjson">konnector-dev-config.json<a class="headerlink" href="#konnector-dev-configjson" title="Permanent link">&para;</a></h3>
<p>If you want to put data from your connector to a real cozy, your must define where to find this
cozy, and this must be a cozy for which you have the credentials.</p>
<p>Here comes the <code>COZY_URL</code> in konnector-dev-config.json which defines just that.</p>
<h3 id="run-the-dev-mode">Run the dev mode<a class="headerlink" href="#run-the-dev-mode" title="Permanent link">&para;</a></h3>
<p>Then you just have to run:</p>
<div class="codehilite"><pre><span></span>yarn dev
</pre></div>


<p>For the first run, the CLI will open a tab in your browser asking you to grant permissions to the
connector. The connector will then save data directly into your cozy. This will validate that your
manifest has the needed permissions on the data you want to save.</p>
<p>This is the <em>dev</em> mode</p>
<h2 id="integration-in-the-store-for-all-the-users">Integration in the store for all the users<a class="headerlink" href="#integration-in-the-store-for-all-the-users" title="Permanent link">&para;</a></h2>
<p>To run a connector, we do not want the cozy to install all dependencies of the connector each time
it installs it.</p>
<p>To avoid this, the connectors need to be compiled into one file in a dedicated branch of the
repository and the repository needs to be a public git repository. The <code>package.json</code> file
from <a href="https://github.com/cozy/cozy-konnector-template">cozy-konnector-template</a> gives you the commands to do this : <code>yarn build</code> and <code>yarn deploy</code>
but the last one needs to be configured in <code>package.json</code></p>
<p>Once your public git repository is configured, you only have to declare it.</p>
<p>Cozy will soon have a store for connectors and you will be able to publish connectors yourself. But
at the moment, you need to declare your new connector on the <a href="https://forum.cozy.io">cozy forum</a>.
The Cozy team will review your code and add your connector to the <a href="https://github.com/cozy/cozy-collect">Cozy Collect</a> application.</p>
<p>To make the connector available more quickly for all cozys, you can follow this few steps of
packaging:</p>
<h3 id="icon">Icon<a class="headerlink" href="#icon" title="Permanent link">&para;</a></h3>
<p>You need to push an icon in <code>assets/</code>. Please respect this rules :</p>
<ul>
<li>Square icon, possibly a png or svg</li>
<li>Try the Apple app store icon if needed</li>
</ul>
<h3 id="packagejson">Package.json<a class="headerlink" href="#packagejson" title="Permanent link">&para;</a></h3>
<ul>
<li>Edit the name to be cozy-konnector-&lt;slug></li>
<li>Edit the repository URL</li>
<li>Edit the command <code>deploy</code> with the correct repository URL</li>
</ul>
<h3 id="manifestkonnector">Manifest.konnector<a class="headerlink" href="#manifestkonnector" title="Permanent link">&para;</a></h3>
<ul>
<li>Edit the name with a nice name (Capitals and spaces allowed here)</li>
<li>Edit icon as needed</li>
<li>Edit slug (no capitals and no spaces here)</li>
<li>Edit source with the correct repository URL</li>
<li>Add a correct vendor link</li>
<li>Choose one or more categories (used to sort connectors in Cozy Store)  in this list : <code>banking, shopping, insurance, isp, telecom, energy, public_service, other</code>.</li>
<li>If needed, change the input type the target website use to login the user: <code>text</code>, <code>email</code> or <code>phone</code> for instance, this will enforce pre-checking</li>
<li>Edit for both locales <code>en</code> and <code>fr</code> the short description and long description</li>
</ul>
<h2 id="faq">FAQ<a class="headerlink" href="#faq" title="Permanent link">&para;</a></h2>
<h3 id="when-i-run-my-connector-a-ghost-node-process-eats-all-my-memory">When I run my connector, a ghost node process eats all my memory<a class="headerlink" href="#when-i-run-my-connector-a-ghost-node-process-eats-all-my-memory" title="Permanent link">&para;</a></h3>
<p>Cozy-konnector-libs uses <a href="https://cheerio.js.org">cheerio</a> which is great but causes some problems
when you try to console.log a cheerio object.</p>
<p>In standalone or dev mode, the BaseKonnector tries to catch errors and display a maximum of details
about them. But when the error contains a cheerio object, the problem happens.</p>
<p>If you get this problem, catch the error yourself and only display the message :</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="c1">// good</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="c1">// bad</span>
<span class="p">}</span>
</pre></div>


<h3 id="how-do-i-scrap-a-website">How do I scrap a website<a class="headerlink" href="#how-do-i-scrap-a-website" title="Permanent link">&para;</a></h3>
<p>Use the request function from <a href="https://github.com/cozy/cozy-konnector-libs">cozy-konnector-libs</a> with the proper options.</p>
<p>Here’s a sample code that will fetch the login page to get the value of the anti-CSRF token, submit the login form, browse to the bills page and fetch a bill:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="p">{</span><span class="nx">BaseKonnector</span><span class="p">,</span> <span class="nx">requestFactory</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cozy-konnector-libs&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">rq</span> <span class="o">=</span> <span class="nx">requestFactory</span><span class="p">({</span>
  <span class="nx">jar</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// handle the cookies like a browser</span>
  <span class="nx">json</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// do not try to parse the result as a json document</span>
  <span class="nx">cheerio</span><span class="o">:</span> <span class="kc">true</span> <span class="c1">// automatically parse the result with [cheerio](https://github.com/cheeriojs/cheerio)</span>
<span class="p">})</span>
<span class="kr">const</span> <span class="nx">moment</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseKonnector</span><span class="p">(</span><span class="kd">function</span> <span class="nx">fetch</span> <span class="p">(</span><span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">rq</span><span class="p">(</span><span class="s2">&quot;https://login.remote.web&quot;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">$</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// the result is automatically wrapped with cheerio and you can use it like jQuery</span>
    <span class="kr">const</span> <span class="nx">form</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">form</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">login</span><span class="o">:</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">login</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span>
        <span class="nx">csrf_token</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[name=&quot;csrf_token&quot;]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rq</span><span class="p">({</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
      <span class="nx">form</span>
    <span class="p">})</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">$</span> <span class="p">=&gt;</span> <span class="nx">rq</span><span class="p">(</span><span class="s2">&quot;https://admin.remote.web/bills&quot;</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">$</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[{</span><span class="nx">date</span><span class="o">:</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#bill_date&quot;</span><span class="p">)),</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#bill_value&quot;</span><span class="p">)}]</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">entries</span> <span class="p">=&gt;</span> <span class="nx">addData</span><span class="p">(</span><span class="nx">entries</span><span class="p">,</span> <span class="s1">&#39;io.cozy.bills&#39;</span><span class="p">))</span>
<span class="p">})</span>
</pre></div>
                </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <!-- Piwik -->
        <script type="text/javascript">
          var _paq = _paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u="//matomo.cozycloud.cc/";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', '7']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <noscript><p><img src="//matomo.cozycloud.cc/piwik.php?idsite=7&rec=1" style="border:0;" alt="" /></p></noscript>
        <!-- End Piwik Code -->
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../extra.js"></script>
        <script src="../../search/main.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
